#!/bin/bash
# vim: et smartindent sr sw=4 ts=4:
#
# For running on Alpine.
#
# CAVEAT: script only works with single binary versions
# i.e versions greater than $XVER
#
# Use to install multiple versions of terraform.
# and switch between them.
#
# /usr/local/bin/terraform is symlinked to desired
# versioned one under /usr/local/bin.
#
# Also installs vim plugin if pathogen detected.
#
APP=terraform
XVER=0.6.16
VER=${1:-$TERRAFORM_VERSION}
BIN="${TERRAFORM_BIN:-/usr/local/bin}"
ZIP="$BIN/${APP}-$VER.zip"
BUILD_PKGS=""
export PATH="$TERRAFORM_BIN:$PATH"

APK_TMP="/var/cache/apk"

if [[ "$VER" =~ -?(list|show)$ ]]; then

    # ... if we have gnu sort, we can order by semantic version
    # (default busybox sort does not support -V)
    sort_opts="-rV"
    ! apk info 2>/dev/null | grep "^sort$" >/dev/null 2>&1 && sort_opts=""

    echo "Versions available under $BIN:"
    if [[ -L $BIN/${APP} ]]; then
        echo "using: $(ls -l $BIN/${APP} | sed -e 's/.* \([^ ]\+ -> [^ ]\+\)/\1/')"
    elif [[ -x $BIN/${APP} ]]; then
        echo "using: $($BIN/${APP} --version)"
    fi
    f=$(
        set -o pipefail ;
        ls -1 $BIN/${APP}-* 2>/dev/null \
        | sed -e 's/.*${APP}-//' \
        | sort $sort_opts \
        || echo "No terraform binaries found."
    )
    echo "$f" && exit 0
fi

[[ -z "$VER" ]] && echo "ERROR $0: must pass a semantic version!" && exit 1

if ! [[ "$VER" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] ; then
    echo "ERROR $0: "$VER" is not a semantic version!"
    exit 1
fi

if [[ $(echo -e "$VER\n$XVER" | sort -V | head -n 1) == "$VER" ]]; then
    echo "ERROR $0: script only works with versions greater than $XVER" >&2
    exit 1
fi

if [[ -f $BIN/${APP} ]]; then
    if [[ -L $BIN/${APP} ]]; then
        if ! rm $BIN/${APP}
        then
            echo "ERROR $0: ... could not delete symlink $BIN/${APP}"
            exit 1
        fi
    elif [[ -x $BIN/${APP} ]]; then
        OLDVER=$($BIN/${APP} --version | grep '^Terraform v' | sed -e 's/.* v\(.*\)$/\1/')
        if ! mv $BIN/${APP} $BIN/${APP}-$OLDVER
        then
            echo "ERROR $0: ... could not move existing to $BIN/${APP}-$OLDVER"
            exit 1
        fi
    else
        echo "ERROR $0: ... $BIN/${APP} is not a bin or symlink to bin"
        exit 1
    fi
fi

if [[ ! -x $BIN/${APP}-$VER ]]; then
    BASE_URI="https://releases.hashicorp.com/${APP}"
    DOWNLOAD_URI="$BASE_URI/$VER/${APP}_${VER}_linux_amd64.zip"

    REQ_PKGS="wget unzip ca-certificates"
    for p in $REQ_PKGS; do
        if ! apk info 2>/dev/null | grep "^${p}$" >/dev/null 2>&1
        then
            BUILD_PKGS="$BUILD_PKGS $p"
        fi
    done

    if [[ ! -z $(echo "$BUILD_PKGS" | sed -e 's/ //g') ]] ; then
        echo "ERROR $0: apk pkgs $BUILD_PKGS required. Please install these first."
        exit 1
    fi

    echo "INFO $0: ... downloading ${APP} $VER"
    if ! wget -q -T 60 -O $ZIP $DOWNLOAD_URI
    then
        echo "ERROR $0: could not download $VER from $DOWNLOAD_URI"
        echo "ERROR $0: ... are you sure it exists?"
        rm $ZIP >/dev/null 2>&1
        exit 1
    fi
    if ! unzip -p $ZIP | cat >$BIN/${APP}-$VER
    then
        echo "ERROR $0: could not extract ${APP} from zip"
        exit 1
    fi
    chmod a+x $BIN/${APP}-$VER
    rm -f $ZIP
else
    echo "INFO $0: ... $BIN/${APP}-$VER available ."
fi

echo "INFO $0: ... pointing $BIN/${APP} to $VER"
if ! ln -s $BIN/${APP}-$VER $BIN/${APP}
then
    echo "ERROR $0: could not repoint $BIN/${APP}"
    exit 1
fi

if ${APP} --version | grep "v${VER}$" 2>/dev/null
then
    echo "INFO $0: installed ${APP} $VER successfully"
else
    echo "INFO $0: failed to install"
    exit 1
fi

# ... install vim plugin if appropriate
if [[ -w /etc/vim/bundle ]] && [[ ! -d /etc/vim/bundle/vim-${APP} ]]; then
    echo "INFO $0: will try to install vim ${APP} plugin"
    if ! apk info 2>/dev/null | grep '^git$' >/dev/null 2>&1
    then
        echo "INFO $0: please apk-add 'git' if you want the terraform vim plugin."
    else
        (
            cd /etc/vim/bundle
            git clone https://github.com/hashivim/vim-${APP}.git
            rm -rf vim-${APP}/.git
        )
    fi
fi

rm -rf $APK_TMP/* >/dev/null 2>&1

exit 0
